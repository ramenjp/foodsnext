<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<meta name="_login_id" th:content="${session.account.id}"/>
<head th:replace="common/common_header::base_header(~{::title})">
    <title>トップ</title>
</head>
<body>

<nav th:replace="common/loggedinNav::navi(${accountName})"></nav>

<div class="container-fluid bg-image">
    <div class="row bg-mask">
        <nav class="col-sm-2 col-md-2 d-none d-md-block bg-light sidebar">
            <div class="sidebar-sticky">
                <ul class="nav flex-column">
                    <h4 class="sidebar-heading d-flex align-items-center px-3 mt-4 mb-1 text-muted">
                        <span><i class="far fa-address-card">&nbsp;</i>アカウント機能</span>
                    </h4>

                    <li class="nav-item">
                        <a href="/account/update/init" class="nav-link">
                            アカウント情報更新
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/account/password/init" class="nav-link">
                            パスワード更新
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/account/search/init" class="nav-link">
                            アカウント一覧検索
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/account/search/paging/init" class="nav-link" data-toggle="tooltip" title="ページング機能を実装しています。">
                            ページング検索</small>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/account/upload/init" class="nav-link" data-toggle="tooltip" title="プロフィール画像のアップロードはこちら。">
                            画像アップロード</a>
                    </li>
                    <li class="nav-item">
                        <a href="/account/unsubscribe/init" class="nav-link">
                            退会
                        </a>
                    </li>
                </ul>

                <h6 class="sidebar-heading d-flex align-items-center px-3 mt-4 mb-1 text-muted">
                    <span><i class="fas fa-tasks"></i>&nbsp;TODO機能</span>
                </h6>
                <ul class="nav flex-column mb-2">
                    <li class="nav-item">
                        <a href="/todo/register/init" class="nav-link">
                            TODO登録
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/todo/search/init" class="nav-link">
                            TODO一覧検索
                        </a>
                    </li>
                </ul>

                <!-- 天気予報 -->
                <h6 class="sidebar-heading d-flex align-items-center px-3 mt-4 mb-1 text-muted">
                    <span><i class="fas fa-sun"></i>&nbsp;天気予報</span>
                </h6>
                <div class="weather-contents">
                    <table class="table-light">
                        <tr>
                            <th>本日</th>
                            <th>明日</th>
                        </tr>
                        <tr>
                            <td class="tday-img"></td>
                            <td class="nday-img"></td>
                        </tr>
                        <tr>
                            <td class="tday-text"></td>
                            <td class="nday-text"></td>
                        </tr>
                        <tr>
                            <td class="tday-temp"></td>
                            <td class="nday-temp"></td>
                        </tr>
                    </table>
                </div>

            </div>
        </nav>

        <div class="col-md-10">
            <div>&nbsp;
            </div>
            <div class="card rounded-0">
                <div class="card-header bg-custom1">
                    <h3 class="mb-0">つぶやき</h3>
                </div>
                <div class="card-body bg-gray1">
                    <form id="commentForm" method="post">
                        <fieldset id="comment_field">
                            <textarea class="form-control" id="comment" rows="3" cols="80" maxlength="255" name="comment" required placeholder="メンバーとお話してみよう"></textarea>
                        </fieldset>
                        <div class="col text-right" style="margin-top:10px;">
                            <input type="submit" value="投稿" class="btn btn-lg bg-info text-white" />
                        </div>
                    </form>
                    <div id="commentSearchResult"></div>
                </div>
            </div>

            <div>&nbsp;
            </div>

            <!-- TODOリスト -->
            <div class="card rounded-0" th:if="!${#lists.isEmpty(list)}">
                <div class="card-header bg-custom1">
                    <h4 class="mb-0">現在担当しているTODO</h4>
                </div>
                <div class="card-body bg-gray1">
                    <div class="todo">
                        <div th:each="todo : ${list}" class="todo-list">
                            <img src="/images/memo.png">
                            <div class="text">
                                <p th:text="${todo.title}"></p>
                                <p th:text="'開始日:' + ${todo.startDate}"></p>
                                <p th:text="'終了日:' + ${todo.endDate}"></p>
                                <p th:text="'優先度:' + ${allPriority.priority.get(todo.priority)}"></p>
                                <p th:text="'ステータス:' + ${allStatus.status.get(todo.status)}"></p>
                                <div class="btn">
                                    <a class="btn btn-info" th:href="@{/todo/search/detail(todoId=${todo.id})}" target="newtab">詳細を見る</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div>&nbsp;
            </div>
        </div>
    </div>
    <!-- 天気予報取得処理  -->
    <script>
        $.getJSON("/weather", function(json){
            var t_data  = json.forecasts[0];
            var n_data = json.forecasts[1];
            var tday_min = $.isEmptyObject(t_data.temperature.min) ? "-" : t_data.temperature.min.celsius;
            var tday_max = $.isEmptyObject(t_data.temperature.max) ? "-" : t_data.temperature.max.celsius;
            var nday_min = $.isEmptyObject(n_data.temperature.min) ? "-" : n_data.temperature.min.celsius;
            var nday_max = $.isEmptyObject(n_data.temperature.max) ? "-" : n_data.temperature.max.celsius;
            $('.tday-img').append('<img src="' + t_data.image.url + '" >');
            $('.nday-img').append('<img src="' + n_data.image.url + '" >');
            $('.tday-text').append(t_data.telop);
            $('.nday-text').append(n_data.telop);
            $('.tday-temp').append(tday_max + '/' +  tday_min + '℃');
            $('.nday-temp').append(nday_max + '/' +  nday_min + '℃');
        });
    </script>

    <script type="text/javascript">
        window.onload = function () {
            commentGet();
        };

        $("#commentForm").submit(function(event) {
            // 要素規定の動作をキャンセルする
            event.preventDefault();
            //データをJSONに加工
            var JSONdata = {
                "comment": $("#comment").val()
            };

            // CSRFトークンをリクエストヘッダに付加する
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");
            $(document).ajaxSend(function(e, xhr, options) {
                xhr.setRequestHeader(header, token);
            });

            var ajaxUrl = "/comment/register";

            $.ajax({
                type: 'post',                       // HTTP通信の種類
                url: ajaxUrl,                       // リクエストを送信する先のURL
                dataType: 'json',                   // サーバーから返されるデータの型
                contentType: 'application/json',    // 送信するデータの型
                data: JSON.stringify(JSONdata)      // 送信するデータ
                // Ajax通信が成功した時の処理
            }).done(function(data) {
                commentGet();
                //textareaの中身を空にする
                $("#comment").val("");
                // Ajax通信が失敗した時の処理
            }).fail(function(data) {
                alert("投稿が失敗しました。\n半角スペースのみでの投稿はできません。");
            });
        });

        function commentDelete(id){
            // 要素規定の動作をキャンセルする
            event.preventDefault();
            // CSRFトークンをリクエストヘッダに付加する
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");
            $(document).ajaxSend(function(e, xhr, options) {
                xhr.setRequestHeader(header, token);
            });
            //データをJSONに加工
            var JSONdata = {
                "id":id
            };
            var ajaxUrl = "/comment/delete/"+ id;
            $.ajax({
                type: 'delete',                    // HTTP通信の種類
                url: ajaxUrl,                      // リクエストを送信する先のURL
                contentType: 'application/json',   // 送信するデータの型
                data: JSON.stringify(JSONdata)     // 送信するデータ
                // Ajax通信が成功した時の処理
            }).done(function(data) {
                commentGet();
                // Ajax通信が失敗した時の処理
            }).fail(function(data) {
                alert("削除に失敗しました。");
            });

        }

        function commentGet(){
            $.getJSON("/comment/search", function(json){
                var src = "";
                $('#commentSearchResult').html(src);
                for(var i=0; i<json.length; i++){
                    var id = json[i].id;
                    var loginId = json[i].loginId;
                    var name = json[i].name;
                    var comment = json[i].comment;
                    var createdTms = json[i].createdTms;
                    comment = removeTags(comment);
                    comment = convertBr(comment);

                    src += '<div class="row">';
                    src += '<div class="col-1 col-md-1">';
                    src += '<img src="/image/profile?id=' + loginId + '" width="120%" class="rounded">';
                    src += '</div>';
                    src += '<div class="col-10 col-md-10">';
                    src += '<b>' + name + '</b>さん';
                    src += '<p style="font-size:0.9em;">' + comment + '</p>';
                    src += '<small>(' + createdTms + ')</small>';
                    if(loginId == $("meta[name='_login_id']").attr("content")) {
                        src += ' <small><a id="commentDelete" onclick="commentDelete(' + id + ');" href="#">削除</a></small>';
                    }
                    src += '</div>';
                    src += '</div>';
                    src += '<hr>';
                }
                $('#commentSearchResult').append(src);
            });
        }
    </script>
</body>
</html>